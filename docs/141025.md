# 2025-10-14 Daily Update

## Modularization Plan
- Documented a three-phase roadmap covering legacy responsibility inventory, target architecture boundaries, and staged extraction tasks required to complete the package refactor.

## Completed Work
- Replaced the stubbed `presentation.assembly` with the refactored production builder and added a configuration override so the CLI can inject alternate configs.
- Swapped the CLI to use the new assembly module, wired logging directly, and removed all references to `scripts/excel_to_ppt_v1_071025.py` before deleting the legacy file.
- Added targeted tests for ingestion edge cases, table composition, and a CLI smoke test alongside the existing chart coverage.

## Current Assessment
- **Config/Data**: Helpers expose clean parsing entry points, though `DataSet` still wraps a bare DataFrame and may need richer typed views later.
- **Presentation**: Assembly logic now lives in-package; heavy slide composition code persists but is centrally configurable.
- **CLI/Utils**: CLI executes entirely through the modular pipeline with logger/config injection support.
- **Testing**: Unit and smoke coverage exists for charts, tables, data helpers, and CLI; comprehensive slide rendering snapshots remain future work.

## Next Focus
- Monitor the modular pipeline with real inputs, trim residual duplication inside `assembly`, and consider snapshot-based slide regression tests.

## Template Migration Decisions (2025-10-14)
- Adopt `template/Template_V4_FINAL_071025.pptx` as the sole output template; retire the legacy deck.
- Populate every slide element (tables, quarterly callouts, media/funnel badges, comments, footer) dynamically from Lumina data or config defaults without altering design specifics.
- Introduce a configuration-driven shape contract and validator, allowing PPT shape renaming for clarity while preserving visuals.
- Document and execute a metric cross-verification checklist to confirm Excel-to-PPT fidelity before release.
- Raise business-rule questions during implementation if new scenarios appear; decisions will be logged here as resolved.

## Template Migration Research Plan
1. Reverse-engineer both templates to catalogue shapes, positions, and semantics, noting gaps and new elements.
2. Analyze `template/BulkPlanData_2025_10_14.xlsx` to map each slide metric back to Lumina fields.
3. Extend configuration with the new template element map and add validation guardrails.
4. Plan `presentation.assembly` updates and tests to consume the new contract and populate additional elements.
5. Create and run a metric cross-verification checklist to guarantee 100% data fidelity in generated decks.

## Template Migration Progress (2025-10-14)
- Completed template reverse-engineering: catalogued old vs new slide elements and renamed key shapes in `Template_V4_FINAL_071025.pptx` (e.g., `QuarterBudgetQ1`, `MediaShareTelevision`).
- Inspected `BulkPlanData_2025_10_14.xlsx` through the ingestion pipeline to confirm processed dataset columns and available metrics for mapping.
- Updated `master_config.json` with new table geometry and introduced `summary_tiles` configuration scaffold for quarterly, media share, funnel share, and footer elements.
- Expanded `master_config.json` element specifications (title shape, summary tile number formats, footer behaviour) to back the new template contract.
- Added template shape validator to block generation if required elements are missing from the master slide.
- Replaced legacy slide population with contract-driven helpers (title, quarterly/media/funnel tiles, footer) and retired pie-chart rendering path.
- Confirmed configuration alignment: CLI uses `config/master_config.json`, `presentation` module consumes the same, and data ingestion references documented column mappings.
- Output routing enforced via config (timestamped folders under `output/presentations/run_{timestamp}` with `.pptx` suffix).

### Data ➜ Template Mapping (Draft)
- **Table Columns**: feed directly from `load_and_prepare_data` output (`Campaign Name`, `Total Cost`, `GRP`, `Reach 1+`, `Frequency`, `Mapped Media Type`, monthly budgets Jan–Dec) with continuation logic unchanged.
- **Quarterly Budgets**: compute Q1–Q4 via summed monthly budgets (`Jan+Feb+Mar`, `Apr+May+Jun`, etc.); format using `£{value:,.0f}K` as defined in config.
- **Media Share Tiles**: aggregate `Total Cost` by `Mapped Media Type` (Television/Digital/Other) for the active country/brand/year; output percentage of overall combination budget.
- **Funnel Share Tiles**: aggregate `Total Cost` by `Funnel Stage` (Awareness/Consideration/Purchase) and compute percentage split; default to `0%` when budget absent.
- **Footer Notes**: render static copy from config with data-export date suffix (to be generated during run).
- **Title Placeholder**: use format `{market} - {brand}` with market normalized to template display rules.

### Calculation Rules (In Progress)
- **Monthly → Quarter**: Sum raw monthly budgets using decimal precision, then format rounded values according to config. Guard against floating rounding differences (<£1) when reconciling totals.
- **Campaign % of Total**: `campaign_total_cost / market_brand_total_cost`; display as `0.0%` when denominator is zero. Enforce cumulative rounding tolerance of ±0.5%.
- **Media Share**: Use normalized `Mapped Media Type`; treat TV synonyms via `normalize_media_type`. Percentages computed on same denominator as campaign %. Any residual remainder assigned to the "Other" tile.
- **Funnel Share**: Group by `Funnel Stage`; if missing or blank, allocate to "Other" bucket (display 0%) while logging for audit.
- **GRP / Reach / Frequency**: Keep existing display logic—blank when data missing, dash placeholder for sub-rows; avoid converting to zero.
- **Footer Date Stamp**: Append `Data as of {Excel export date}` extracted from workbook metadata/filename.
- **Validation Checks**: After calculations, assert (a) sum of monthly values equals `Total Cost` within tolerance, (b) media share + funnel share each total 100% (±0.5%), (c) quarter sums roll up to annual total.

### Current Blocker
- `presentation.assembly` still references legacy placeholders (title, comments, charts) and pie-chart generation paths. Further edits were paused pending reconciliation of these sections with the new template contract to avoid partial migrations.

## Planned Refactor Blueprint
### Phase 0 – Contract Baseline
- Finalize shape naming in `Template_V4_FINAL_071025.pptx` and lock configuration schema for table + summary tiles.
- Implement a validator that confirms required shapes exist with correct casing before slide generation.

### Phase 1 – Configuration + Data Mapping
- Extend `master_config.json` with explicit coordinate/format specs for title, quarterly budgets, media mix, funnel share, and footer copy.
- Produce a definitive data-binding map linking each slide element to the processed dataset (including derived quarter totals, media percentages, and funnel splits).

### Phase 2 – Assembly Refactor
- Replace legacy title/comments/chart population code with new helpers that read the element contract, update shapes via `python-pptx`, and remove chart creation paths.
- Introduce reusable formatting utilities for percentage and currency rendering consistent with template typography.

### Phase 3 – Verification Layer
- Build a metric cross-verification checklist comparing Excel source values to PPT outputs (unit tests plus manual QA script dumping first slide metrics).
- Add integration tests that run the CLI against a fixture and assert presence/values of key text boxes and table cells.

#### Phase 3 Verification Checklist (WIP)
1. **Table Integrity**
   - Confirm monthly budgets Jan–Dec sum to the `Total Cost` column for each campaign.
   - Verify quarter columns (if present post-split) match the sum of respective months.
   - Ensure `%` column equals campaign total divided by combination total (rounded to 0.1%).
   - Cross-check GRP/Reach/Frequency values against raw Lumina metrics for TV campaigns.
2. **Summary Tiles**
   - Recalculate Q1–Q4 totals from table data and confirm against tile text.
   - Aggregate media share and funnel share percentages and assert they total 100% (±0.5%).
3. **Static Elements**
   - Confirm title text matches `{market} - {brand}` format and slide numbering when split.
   - Validate footer notes include correct static text plus appended date stamp.
4. **Structural Checks**
   - Validate template shape presence via automated validator (already enforced in code).
   - Confirm comment placeholders remain blank (feature disabled) and no legacy charts appear.

#### Integration Test Plan
- Create a slim fixture workbook (3 campaigns, multi-media mix) and expected summary metrics.
- Run CLI to generate a PPT in a temporary directory during tests.
- Parse PPTX using `python-pptx` to extract:
  - Table header/first row values.
  - Quarter/media/funnel tile text.
  - Footer text including appended date.
- Assert extracted values match expected calculations within tolerance.
- Clean up generated files after assertions.

### Phase 3B – Audit & Certification
- Run multi-market regression builds and produce reconciliation reports comparing PPT outputs to Lumina source totals (monthly, quarterly, media, funnel).
- Validate all dynamic vs static elements slide-by-slide, ensuring calculated values (percentages, currency formatting, footnotes) match approved rules.
- Capture anomalies in an audit log, resolve discrepancies, and secure stakeholder sign-off before rollout.

#### Sign-off Procedure
- Consolidate reconciliation reports and anomaly logs into a single summary.
- Review outstanding issues; rerun generation after fixes to confirm resolution.
- Secure stakeholder approval (document timestamp, approver, dataset list) before promoting the new template to production.

#### Regression Audit Plan (Draft)
- **Slide-by-Slide QA Protocol**:
  - For each regression deck, select sample slides (first per market, any continuation, last slide).
  - Verify title text, table bounds, tile formatting, and footer against template design.
  - Ensure disabled elements (comments, charts) remain hidden.
  - Log findings in `docs/audit_log.md` with dataset, slide index, issue description, and resolution.
- **Datasets**: select at least three Lumina exports (high-TV mix, digital-heavy, multi-country) to cover edge cases.
- **Automation**:
  1. Generate PPT for each dataset via CLI (isolated run directories).
  2. Extract table/tile values with an audit script (`scripts/audit_extract.py`) that dumps structured JSON per slide.
  3. Compute expected metrics from source Excel using the documented formulas (leveraging pandas group-bys).
  4. Produce comparison reports (CSV/JSON) highlighting any variances beyond tolerance (0.5% for percentages, £1 for budgets).
- **Manual Spot Checks**: visually inspect a sample of slides per dataset (first, middle, last) to confirm styling and static text.
- **Sign-off Criteria**: zero high-severity discrepancies; any minor rounding differences documented and accepted.

### Phase 4 – Rollout
- Enable the new contract by default, run end-to-end dry-runs over representative Lumina files, and capture sign-off slides.
- Document final behaviors and any business-rule nuances in this log for future maintenance.

#### Phase 4 Dry Run (2025-10-14)
- CLI executed against `template/BulkPlanData_2025_10_14.xlsx`; output saved to `output/presentations/run_{timestamp}/AMP_Presentation_{timestamp}.pptx`.
- Logging highlighted missing named shapes on generated slides (`TitlePlaceholder`, `QuarterBudgetQ*`, media/funnel tiles, `FooterNotes`) and fallback table creation due to absent `Table Placeholder 1` on the layout.
- Table border styling raised an `int()` casting warning when converting `RGBColor`; needs adjustment in border helper.
- Action items: ensure the template layout exposes the required named shapes (or clone them per slide), and update border helper to convert RGB tuples before applying.

##### Update – Shape Cloning + Footer Date (2025-10-14)
- Added runtime shape cloning helper (`_ensure_shape_on_slide`) so quarter/media/funnel tiles and footer are copied from the template slide when missing.
- Injected `TitlePlaceholder` textbox into the template and ensured quarter/media/funnel tiles copy their source text styling when replicated.
- Reworked footer population to extract the export date from the Excel filename (fallback to file mtime/current time) so the slide footer reflects the workbook timestamp `DD_MM_YY`.
- Table border helper now converts `RGBColor` to its hex string representation before setting XML attributes, removing the prior casting warning.

##### Sign-off Samples (2025-10-14)
- Verified populated slides from `output/presentations/run_20251014_154719/AMP_Presentation_20251014_154719.pptx`:
  - **Slide 1 – KSA · Sensodyne (1 of 3):** Q1–Q4 budgets `£659K/£1,211K/£1,828K/£1,010K`; media split `TV 0% · Digital 48% · Other 2%`; funnel `82%/14%/4%`; footer stamped `Data as of 14_10_25`.
  - **Slide 4 – KSA · Panadol:** Budgets track Lumina totals `£1,128K/£300K/£340K/£773K`; Digital share 52%; funnel `75%/25%/0%`.
  - **Slide 10 – KSA · Nicotinell:** Quarter tiles display `£0K/£68K/£0K/£0K` with Digital share 100% and funnel `100%/0%/0%` (expected single-channel spend).
  - **Slide 20 – GINE · Otrivin:** Budgets `£384K/£4K/£5K/£384K`; media split `0%/45%/1%`; funnel `88%/2%/10%`.
  - **Slide 40 – Turkey · Sensodyne (1 of 2):** Budgets `£849K/£1,129K/£765K/£1,157K`; funnel `67%/19%/13%`.
  - **Slide 60 – Market delimiter slide:** intentionally blank summary tiles (delimiter layout confirmed to suppress population).
  - **Slide 80 – Kenya · ENO (1 of 2):** Budgets `£17K/£18K/£40K/£69K`; Digital share 49%; funnel `81%/19%/0%`.

##### Template Geometry Baseline (2025-10-14)
- **Slide Master (index 0)**
  - `Freeform: Shape 14` – 10.000" × 5.625" white rounded frame anchored at `(0.000", 0.000")`; defines permanent border.
- **Layout 0 (“Title and Content”) key shapes**
  - `TitlePlaceholder` – positioned at `(0.184", 0.270")` sized `2.944" × 0.337"`; sample text `RSA – SENSODYNE (25)` baked into layout.
  - `Table 14` placeholder – `(0.184", 1.223")` with width `9.124"`, height `2.433"`; this is the intended anchor for the campaign table (must be honoured to keep internal cell spacing).
  - Legend groups along the top right:
    - `Group 15` → `TelevisionLegendColor`/`TelevisionLegendText` at `(6.478", 0.313")`, width `0.539"`.
    - `Group 1` → `DigitalLegend*` at `(7.088", 0.313")`, width `0.868"`.
    - `Group 4` → `OOHLegend*` at `(8.027", 0.313")`, width `0.648"`.
    - `Group 13` → `OtherLegend*` at `(8.745", 0.313")`, width `0.767"`.
  - Slide number placeholder at `(9.697", 5.325")`, size `0.244"` square.
- **Template Slide (index 0) runtime shapes**
  - `MainDataTable` – `(0.179", 0.698")`, width `9.330"`, height `4.119"`; currently flat layout awaiting grouped block redesign.
  - Quarterly budget bars:
    - `QuarterBudgetQ1` `(2.758", 4.881")` width `1.276"`, height `0.105"`.
    - `QuarterBudgetQ2` `(4.051", 4.881")` width `1.324"`, height `0.105"`.
    - `QuarterBudgetQ3` `(5.392", 4.881")` width `1.446"`, height `0.105"`.
    - `QuarterBudgetQ4` `(6.855", 4.881")` width `1.310"`, height `0.105"`.
  - Media share chips (auto shapes) arranged left-to-right at `top=5.136"` with widths `~1.239"` each: `MediaShareTelevision`, `MediaShareDigital`, `MediaShareOther`.
  - Funnel share chips at `top=5.136"`, widths `~1.124"`: `FunnelShareAwareness`, `FunnelShareConsideration`, `FunnelSharePurchase`.
  - Footer text frame `FooterNotes` at `(0.088", 5.304")` sized `3.585" × 0.269"`; template text `Source: DD_MM_YY_Lumina Export.` on a single line.
- **Implications for Phase B/C**
  - Preserve frame by cloning or preventing slide background reset; ensure any slide duplication retains `Freeform: Shape 14`.
  - Table assembly must respect the placeholder bounds (`Table 14`) rather than free positioning to match white inset margins.
  - Legend assets should remain untouched; automation may only update table + bars, leaving legend groups static for design consistency.

##### Pre-Phase B Baseline (2025-10-14)
- Baseline deck for regression: `output/presentations/run_20251014_162344/AMP_Presentation_20251014_162344.pptx` (generated pre-table redesign).
- Template table expectations (from design source):
  - Campaigns grouped into blocks (e.g., ARMOUR, MEERKAT, FACES) with nested media rows (`TELEVISION`, `DIGITAL`, `OOH`, `RADIO`) and subordinate metric rows (`£000`, `GRPs`, `Reach@1+`, `OTS@3+`).
  - Each block concludes with a grey “MONTHLY TOTAL (£000)” band; the slide closes with a “GRAND TOTAL” row spanning the full width.
  - Monthly columns remain JAN–DEC; totals appear in dedicated columns (`TOTAL`, `GRPs`, `%`) rather than appended Q1–Q4 columns.
  - Colour coding follows media type per cell, with dual-line entries for digital sub-metrics (e.g., YT Reach 30%, META Reach 45%).
  - Table should originate from layout placeholder `Table 14` to maintain inset margin and rounded frame alignment.

##### Phase 3 Verification & Automation (2025-10-14)
- Introduced `amp_automation.validation.reconciliation` with `generate_reconciliation_report` to parse generated PPTs, recompute quarter/media/funnel metrics from Excel, and flag variances beyond ±0.5% / ±0.5%·budget.
- CLI gains `--reconcile` / `--reconciliation-report` switches; reports default to `reconciliation_summary.csv` inside the run folder with per-slide pass/fail status.
- Added targeted regression tests (`tests/test_template_validation.py`) covering reconciliation success and deliberate mismatches using synthetic PPT/Excel fixtures.
- Table creation now inspects the slide layout for `Table Placeholder 1`; if absent it falls back silently to absolute positioning instead of spamming warnings.
- Dry-run with `--reconcile` (output: `output/presentations/run_20251014_162344/`) generated `reconciliation_summary.csv`; all markets except Morocco passed. Morocco slides surfaced as expected-data-missing because Lumina workbook has no rows for `Morocco - Sensodyne` or `Morocco - OH Multibrand`—needs upstream data confirmation.
